#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Set UTF-8 as the default encoding
# http://stackoverflow.com/questions/17031651/invalid-byte-sequence-in-us-ascii-argument-error-when-i-run-rake-dbseed-in-ra
export LANGUAGE=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8

build=$(cd "$1"; pwd); cache=$(cd "$2"; pwd)

if [ -n "$build" ]; then
  spc_count=$(find "$build" -maxdepth 1 -name '*.gemspec' | wc -l)
else
  spc_count=0
fi

if [ -n "$BUILD_VERSION" ]; then
  BUILD_VERSION=$(echo "$BUILD_VERSION" | tr '\-\+' '..')
fi

if [ "$spc_count" -gt 1 ]; then
  echo "ERROR: Multiple .gemspec files present in package root"
  exit 1
fi

bin_dir=$(cd $(dirname $0); pwd)
buildpack_fpm_dir=$(dirname "$bin_dir")

echo "Build pack dir : $buildpack_fpm_dir"
echo "Using ruby     : $(ruby -v)"
echo "Using bundler  : $(bundle -v)"

fpm_path=$(which fpm)
if [ -z "$fpm_path" ]; then
  if [ ! -f "$buildpack_fpm_dir/.bundle/config" ]; then
    echo "Bundling fury-buildpack-fpm to install fpm executable..."
    cd "$buildpack_fpm_dir" && bundle install --path vendor/bundle --without development test
  fi

  echo "Using fpm      : $(cd $buildpack_fpm_dir && bundle exec fpm -v)"
else
  echo "Using fpm      : $(fpm -v)"
fi

# This is a temporary fix, since no way to know the current Gemfile do not work on ruby-19.
# Will be converted into a ENV var later.
export BUNDLE_GEMFILE=$build/spec/gemfiles/Gemfile.19

echo "Using Gemfile  : $BUNDLE_GEMFILE"
echo "Bundling repo in $build..."
cd "$build" && bundle install --path vendor/bundle --without development test

cd "$build" && $bin_dir/support/packguy "$build" "$cache"
exit ${PIPESTATUS[0]}
