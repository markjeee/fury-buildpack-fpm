#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Set UTF-8 as the default encoding
# http://stackoverflow.com/questions/17031651/invalid-byte-sequence-in-us-ascii-argument-error-when-i-run-rake-dbseed-in-ra
export LANGUAGE=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8

# Arguments
build=$1; cache=$2

if [ -n "$build" ]; then
  # Sanity checks
  spc_count=$(find "$build" -maxdepth 1 -name '*.gemspec' | wc -l)
else
  spc_count=0
fi

# Convert SemVer auto-version to Gem::Version
if [ -n "$BUILD_VERSION" ]; then
  BUILD_VERSION=$(echo "$BUILD_VERSION" | tr '\-\+' '..')
fi

# Prepare ourselves for installing

# Let's rock and roll
if [ "$spc_count" -gt 1 ]; then
  echo "ERROR: Multiple .gemspec files present in package root"
  exit 1
else
  bin_dir=$(cd $(dirname $0); pwd)
  buildpack_fpm_dir=$(dirname "$bin_dir")

  echo "Using ruby    : $(ruby -v)"
  echo "Using rake    : $(rake -V)"
  echo "Using bundler : $(bundle -v)"

  cd "$buildpack_fpm_dir"
  bundle install --deployment

  cd "$build"
  bundle install --without development test

  $bin_dir/support/packguy "$build" "$cache"
  exit ${PIPESTATUS[0]}
fi
